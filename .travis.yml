language: minimal

services:
  - docker

env:
  global:
    - DOCKER_ORG_NAME=tidair
    - DOCKER_REPO=smurf-rogue

stages:
  - name: deploy_docker
    if: tag IS present

jobs:
  include:
    - stage: deploy_docker
      name: "Deploy Docker Image"
      before_script:
        # Use the git tag to tag tag docker image
        - export DOCKER_TAG=`git describe --tags --always`
        # Login to docker
        - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_ORG_NAME}" --password-stdin;

      script:
        # Build the docker image
        - docker build -t ${DOCKER_ORG_NAME}/${DOCKER_REPO} .

      after_success:
        # Upload docker image (as tagged and latest version)
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO};
        - docker tag ${DOCKER_ORG_NAME}/${DOCKER_REPO} ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - echo "Docker image '${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG}' pushed"

notifications:
  slack:
    secure: TSs+bAnqtjftxcZD60HO4DZ/g6inMJgzTzPhWWTPFyk//16nrl6Msh3fVMYLRcfcy+jokzCtRUeCg9Bnx+C9myzb5SctmqxSIMXy4ZPnOe629OD+GZlBl8o0ET8hFgVoUN0nz22Spvhy2Qvq9lOfUqEl6UiGc/MVkDwzlirlKeMjmm76mDfkgjQ0s1QxRWUERpESiri2fE5ImCb1e1NjyC5KFDelZlOitHtnZfm2lNnjNMrNpWnrhmMos7BKs0QHWMN/DzIJHZ8mDPyxRDWQSDb3Ajw8Cu8EASi6FCHCj+/9j5JacmZLXLX+zNdFK5D/yvyKMZQ77pXreTpfYs8zrVpm3YMNGjVbK5qNQqnh22OomAoEXZIb3A1+5IqWMeYBFDBqpFp5ipt7bh9dwkZ+FM629DcbenC/KWXZf0ytRHyOBzi1dcWDRpChWsCEbYpT2qa1ybuMrwEDaBNEiXg40l7M5akT88PHGmvcc8a4x20Azlt74BCfeURR6OURU5vViuM7qrIYY0MNGrWXDShTT8xOjAvW+9MNrgRpTgaUfp+p2bT5FVrY8W3nCg3BIQ0Wef3L008cnKLthnZ30HwRNvMyVmFk8FHE7U8PAu93qoDlR/IXE7nwGUTCT3X2sGyV1tFV9kcU8KhgJcCuDPQozqOkI9IQIJayoY3rsaGKZ90=

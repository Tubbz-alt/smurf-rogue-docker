language: minimal

services:
  - docker

env:
  global:
    - DOCKER_ORG_NAME=tidair
    - DOCKER_REPO=smurf-rogue

stages:
  - name: deploy_docker
    if: tag IS present

jobs:
  include:
    - stage: deploy_docker
      name: "Deploy Docker Image"
      before_script:
        # Use the git tag to tag tag docker image
        - export DOCKER_TAG=`git describe --tags --always`
        # Login to docker
        - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_ORG_NAME}" --password-stdin;

      script:
        # Build the docker image
        - docker build -t ${DOCKER_ORG_NAME}/${DOCKER_REPO} .

      after_success:
        # Upload docker image (as tagged and latest version)
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO};
        - docker tag ${DOCKER_ORG_NAME}/${DOCKER_REPO} ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - echo "Docker image '${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG}' pushed"

notifications:
  slack:
    secure: VfOEGrd8TXJVfhyXHt+E0KIlzkC6d1vkfx4ET3xG2Wkm/bSNawLWjoA7cAuh/q8HAadqGHtobafeFoFH4F5g4rNwYdL9LenjnpIDNcnHP3ur8tsGH/Zw4yHBgABUyRoYRWAAhxkZtAlI0gAINnGI4ye8LhhufCFwJFSax1Ga80mEW8HN21V+UoYcnHc0UQYc8hKFtmiPAcVZ7Y+tgbprjYy8q6BHvShIDYJk+Fuqt2IjRToAqCNFqVka/xPfASEgff4iLzjb7YcFlca66mm0MOPCqQ3BepUmPzTw0KANza+6KRj2BLYtqmwTPKDduzhaWaX89jtws53uvxPyxwJ5oMP+WZKu7lkadW4O54WXX4HTMkllKL6xkhMuRClUM+PS2NDLT/DScDp6lbDtHld3/IV3GQRrfBFkODpK259e+y+zGkHrdHjKfvC65c9iS0lmHZo0SeO7tUXkvzWF6/Koc/LkWP53JfBZsE1i4Zm1OBvxiMPPAlNnDaeMIQbZePbLavRhO3MpoGO2pEYM04MGySORK01ExS8tEiizryA8tUWgD0bTwUrMeBUg9LZFlMft3dvq90IZbPcL+sVlGMSWXvmvJzg4KnW5IyuBGOQyP/9ITUC6Mm/QjYcWWZASz1LGuUvTSo46OhnXd7vJ4To3P4+w3/d44LFp5JR4/Zw1a5o=
